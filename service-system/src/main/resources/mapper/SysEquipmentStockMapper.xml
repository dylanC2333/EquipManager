<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.equipment.system.mapper.SysEquipmentStockMapper">

    <resultMap id="BaseResultMap" type="com.equipment.model.system.SysEquipmentStock">
            <id property="id" column="id" jdbcType="BIGINT"/>
            <result property="equipmentCode" column="equipment_code" jdbcType="VARCHAR"/>
            <result property="equipmentDate" column="equipment_date" jdbcType="DATE"/>
            <result property="userCode" column="user_code" jdbcType="VARCHAR"/>
            <result property="taskCode" column="task_code" jdbcType="VARCHAR"/>
            <result property="remarks" column="remarks" jdbcType="VARCHAR"/>
            <result property="type" column="type" jdbcType="CHAR"/>
            <result property="warehouseManagerCode" column="warehouse_manager_code" jdbcType="VARCHAR"/>
            <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
            <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
            <result property="isDeleted" column="is_deleted" jdbcType="TINYINT"/>
            <result property="isTransfer" column="is_transfer" jdbcType="TINYINT"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,equipment_code,equipment_date,
        user_code,task_code,remarks,
        type,warehouse_manager_code,create_time,
        update_time,is_deleted,is_transfer
    </sql>


    <resultMap id="SysEquipmentFinderMap" type="com.equipment.model.system.SysEquipment" autoMapping="true"></resultMap>

    <sql id="equipmentFindercolumns">
        e.equipment_code,e.equipment_name
    </sql>

    <select id="idleEquipmentFinder" resultMap="SysEquipmentFinderMap">
        select distinct <include refid="equipmentFindercolumns" />
        from sys_equipment e
        <where>
            e.status = 1
            <if test="equipFinderVo.keyword != null and equipFinderVo.keyword != ''">
                and e.equipment_name LIKE CONCAT('%', #{equipFinderVo.keyword}, '%')
            </if>
            AND NOT EXISTS(
            SELECT 1
            FROM sys_equipment_stock s
            <where>
                s.equipment_code = e.equipment_code
                <if test="equipFinderVo.startTime != null and equipFinderVo.startTime !=''">
                    <if test="equipFinderVo.endTime != null and equipFinderVo.endTime !=''">
                        and s.equipment_date BETWEEN #{equipFinderVo.startTime} AND #{equipFinderVo.endTime}
                    </if>
                </if>
            </where>
            )
            AND NOT EXISTS(
            SELECT 1
            FROM (
            SELECT s.*, t.location
            FROM sys_equipment_stock s
            LEFT JOIN sys_task t ON s.task_code = t.task_code
            LEFT JOIN sys_equipment e2 ON s.equipment_code = e2.equipment_code
            <where>
                <if test="equipFinderVo.startTime != null and equipFinderVo.startTime !=''">
                    and s.equipment_date &lt; #{equipFinderVo.startTime}
                </if>
            </where>
            ORDER BY s.equipment_date DESC,
            CASE
            WHEN s.type = '出库' THEN 1
            ELSE 0
            END DESC
            LIMIT 1
            ) as last_record
            <where>
                <if test="equipFinderVo.location != null and equipFinderVo.location !=''">
                    and last_record.location = #{equipFinderVo.location}
                </if>
                AND last_record.type = '出库' and last_record.equipment_code = e.equipment_code
            </where>
            )
        </where>

    </select>

    <select id="idleEquipmentFinder2" resultMap="SysEquipmentFinderMap">
        SELECT
        e.equipment_code,
        e.equipment_name
        FROM sys_equipment e
        <where>
            e.status = 1
            AND e.is_deleted = 0  <!-- 主表逻辑删除条件 -->
            <if test="equipFinderVo.keyword != null and equipFinderVo.keyword != ''">
                AND e.equipment_name LIKE CONCAT('%', #{equipFinderVo.keyword}, '%')
            </if>
            <!-- 排除时间段内的库存记录 -->
            AND NOT EXISTS(
            SELECT 1
            FROM sys_equipment_stock s
            <where>
                s.equipment_code = e.equipment_code
                AND s.is_deleted = 0  <!-- 子表逻辑删除条件 -->
                <if test="equipFinderVo.startTime != null and equipFinderVo.startTime !=''">
                    <if test="equipFinderVo.endTime != null and equipFinderVo.endTime !=''">
                        AND s.equipment_date BETWEEN #{equipFinderVo.startTime} AND #{equipFinderVo.endTime}
                    </if>
                </if>
            </where>
            )
            <!-- 验证最后一次出库记录 -->
            AND EXISTS(
            SELECT 1
            FROM (
            SELECT
            s.type,
            t.location,
            s.equipment_code,
            s.is_transfer
            FROM sys_equipment_stock s
            LEFT JOIN sys_task t ON s.task_code = t.task_code
            <where>
                <if test="equipFinderVo.startTime != null and equipFinderVo.startTime !=''">
                    AND s.equipment_date &lt; #{equipFinderVo.startTime}
                </if>
                AND s.is_deleted = 0  <!-- 子表逻辑删除条件 -->
            </where>
            ORDER BY
            s.equipment_date DESC,
            CASE
            WHEN s.type = '出库' THEN 1
            ELSE 0
            END DESC
            LIMIT 1
            ) as last_record
            <where>
                <if test="equipFinderVo.location != null and equipFinderVo.location !=''">
                    AND last_record.location = #{equipFinderVo.location}
                </if>
                AND last_record.type = '出库'
                AND last_record.equipment_code = e.equipment_code
                AND last_record.is_transfer != 2
            </where>
            )
            <!-- 排除时间段内的使用记录 -->
            AND NOT EXISTS(
            SELECT 1
            FROM sys_equipment_use u
            <where>
                u.equipment_code = e.equipment_code
                AND u.is_deleted = 0  <!-- 子表逻辑删除条件 -->
                <if test="equipFinderVo.startTime != null and equipFinderVo.startTime !=''">
                    <if test="equipFinderVo.endTime != null and equipFinderVo.endTime !=''">
                        AND u.equipment_use_date BETWEEN #{equipFinderVo.startTime} AND #{equipFinderVo.endTime}
                    </if>
                </if>
            </where>
            )
        </where>
    </select>

</mapper>
